<!DOCTYPE html>
<!--
    Phantom by HTML5 UP
    html5up.net | @ajlkn
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en">

<head>

    <title>Patrik Svensson - Testing stuff with Windows Sandbox</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/assets/css/highlight.css" rel="stylesheet">
    <!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/assets/css/main.css" />
    <!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
    <!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
    <link href="/assets/css/override.css" rel="stylesheet" />

    <meta name="description" content="This is my blog, where I write about stuff that interests me such as .NET, Rust, CI/CD and technology in general. I am a husband and a father, and I enjoy contributing to Open Source projects." />
    <link type="application/rss+xml" rel="alternate" title="Patrik Svensson" href="/feed.rss" />
    <link type="application/atom+xml" rel="alternate" title="Patrik Svensson" href="/feed.atom" />
    <!--<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">-->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/favicon/site.webmanifest">

    <meta name="application-name" content="Patrik Svensson" />
    <meta name="msapplication-tooltip" content="Patrik Svensson" />
    <meta name="msapplication-starturl" content="/" />

    <meta property="og:title" content="Patrik Svensson - Testing stuff with Windows Sandbox" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://patriksvensson.se/2020/02/testing-stuff-with-windows-sandbox" />
    <!-- TODO: More social graph meta tags -->

    <script src="/assets/js/highlight.pack.js"></script>
</head>

<body>
    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Header -->
        <header id="header">
            <div class="inner">

                <!-- Logo -->
                <a href="/" class="logo">
                    <span class="title">Patrik Svensson</span>
                </a>

            </div>
        </header>

        <!-- Menu -->
        <nav id="menu">
            <h2>Menu</h2>
            <ul>
                <li><a href="/posts">Archive</a></li>
                <li><a href="/tags">Tags</a></li>
            </ul>
        </nav>

        <!-- Main -->
        <div id="main">
            <div class="inner">

                <header>
    <h1>Testing stuff with Windows Sandbox</h1>
    <p><em>Published on Sunday, February 23, 2020</em>
    </p>

    <ul class="actions small">
        <li><a role="button" href="/tags/boxstarter" class="button small ">Boxstarter</a></li>
        <li><a role="button" href="/tags/chocolatey" class="button small ">Chocolatey</a></li>
        <li><a role="button" href="/tags/windows-10" class="button small ">Windows 10</a></li>
        <li><a role="button" href="/tags/windows-sandbox" class="button small ">Windows Sandbox</a></li>
    </ul>
</header>

<div id="content">
    <p>Last week I decided that I wanted to try the new version of Windows Subsystem
for Linux (conveniently
named <code>WSL 2</code>). WSL 2 requires that the computer enrolls in Windows slow ring, and
since the computer I was on didn't receive any insider builds at all, I went
ahead and enabled the slow ring. The update started, and I went to bed.</p>
<p>When I woke up the next morning, I saw this:</p>
<p><img src="/images/fubar.jpg" alt="computer can't find MBR" /></p>
<p>I tried restoring the master boot record using a recovery disk, but I couldn't
get this to work for some unknown reason.</p>
<p>Luckily (ðŸ˜…), my computer crashed for almost the same reason a couple of months
ago, so I had started to prepare some scripts to help me set up a new computer
using <a href="https://chocolatey.org/">Chocolatey</a> and
<a href="https://boxstarter.org/">Boxstarter</a>. The scripts were far from perfect but
worked well enough to get my computer up and running in less than 30 minutes.</p>
<p><img src="/images/boxstarter.jpg" alt="Boxstarter" /></p>
<p>After the installation, I started making some adjustments to the script and
wanted to try it all out. Since I want the setup part to be as smooth as
possible, I was contemplating whether to do another reinstall of Windows and
rerun it. Then I remembered that Microsoft recently released a new technology
based on <a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/">Windows Containers</a>
called <code>Windows Sandbox</code>.</p>
<p><a href="https://techcommunity.microsoft.com/t5/windows-kernel-internals/windows-sandbox/ba-p/301849">Windows Sandbox</a>
is an entirely isolated environment running under your existing Windows
installation. Every time you close the sandbox, the content of it gets removed.
The sweet part of this is that it starts in mere seconds, so it's perfect for
testing things that, in some way, alter a computer's state or perform some
destructive operation.</p>
<h2 id="installing-windows-sandbox">Installing Windows Sandbox</h2>
<p>Installing Windows Sandbox is as simple as running the following command from a
PowerShell console:</p>
<pre><code class="language-powershell">PS&gt; Enable-WindowsOptionalFeature -FeatureName &quot;Containers-DisposableClientVM&quot; -All -Online
</code></pre>
<p>Restart your computer for the change to take effect. Once the
computer rebooted, search for <code>Sandbox</code> in the start menu to start it. The
startup time is slightly longer the first time you start it, but after the
initial run, it should start within a second or so.</p>
<h2 id="configuring-the-windows-sandbox">Configuring the Windows Sandbox</h2>
<p>When I started tweaking my install scripts, the routine looked something like
this:</p>
<ol>
<li>Start Windows Sandbox</li>
<li>Copy files from the host machine to the sandbox</li>
<li>Open a PowerShell prompt</li>
<li>Enable execution of PowerShell script via <code>Set-ExecutionPolicy</code></li>
<li>Go to the script directory</li>
<li>Run the installation script</li>
<li>Wait for the script to finish running</li>
</ol>
<p>This little routine quickly became tedious, but after some detective work on the
Internet, I discovered that this was automatable by creating a configuration file
to initialize the sandbox. The configuration file has the extension <code>.wsb</code> and
works almost like an old fashion <code>.rdp</code> file, with the only difference that
<em>wsb</em> file is an XML file instead of an INI file. You create one and double
click it, and a new Sandbox environment gets created for you.</p>
<p>In my case this file looks like this:</p>
<pre><code class="language-xml">&lt;Configuration&gt;
&lt;VGpu&gt;Disable&lt;/VGpu&gt;
&lt;Networking&gt;Disable&lt;/Networking&gt;
&lt;MappedFolders&gt;
   &lt;MappedFolder&gt;
     &lt;HostFolder&gt;D:\Source\github\patriksvensson\machine\windows&lt;/HostFolder&gt;
     &lt;ReadOnly&gt;true&lt;/ReadOnly&gt;
   &lt;/MappedFolder&gt;
&lt;/MappedFolders&gt;
&lt;LogonCommand&gt;
   &lt;Command&gt;C:\users\WDAGUtilityAccount\Desktop\machine\run.cmd&lt;/Command&gt;
&lt;/LogonCommand&gt;
&lt;/Configuration&gt;
</code></pre>
<p>So by simply double-clicking on the configuration file, A new sandboxed
environment gets created, and my installation script starts.</p>
<p><img src="/images/windows-sandbox.png" alt="Windows Sandbox" /></p>
<h2 id="detect-if-youre-running-in-the-sandbox">Detect if you're running in the sandbox</h2>
<p>There are some things you don't want to do in a sandboxed environment. Perhaps
it's not permitted, such as installing the Windows Sandbox, or you don't
want to run some part of your script.</p>
<p>Detecting whether or not you're in a sandboxed environment is reasonably
straightforward; check if the current username is <code>WDAGUtilityAccount</code>.</p>
<pre><code class="language-powershell">if($env:UserName -ne &quot;WDAGUtilityAccount&quot;) {
    # Do things that can't be done in Windows Sandbox.
}
</code></pre>
<h2 id="wrapping-up">Wrapping up</h2>
<p>So hopefully, this blog post might be of help to you if you need a
sandboxed environment. If you're interested in taking a look at my installation
scripts, you can find them at
<a href="https://github.com/patriksvensson/machine">https://github.com/patriksvensson/machine</a>.
These scripts are highly personal, so you probably want to change them.
For the same reason, I'm not accepting any pull requests, but if you have any
suggestions, feel free to reach out to me on Twitter.</p>

</div>

            </div>
        </div>

        <!-- Footer -->
        <footer id="footer">
            <div class="inner">
                <section>
                    <h2>Feeds</h2>
                    <ul class="actions small vertical">
                        <li><a href="/rss.xml" class="button small"><i class="fa fa-rss"></i> RSS Feed</a></li>
                        <li><a href="/feed.xml" class="button small"><i class="fa fa-rss"></i> Atom Feed</a></li>
                    </ul>
                </section>
                <section>
                </section>
                <ul class="copyright">
                    <li>Copyright Â© 2020 Patrik Svensson</li>
                    <li>Blog forked from <a href="https://github.com/mholo65/mholo65">Martin BjÃ¶rkstrÃ¶m</a></li>
                    <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                    <li><a href="https://statiq.dev/">Generated by Statiq</a></li>
                </ul>
            </div>

        </footer>

    </div>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53005417-1', 'auto');
    ga('send', 'pageview');
</script>
    <!-- Scripts -->
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/skel.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
    <script src="/assets/js/main.js"></script>

</body>

</html>