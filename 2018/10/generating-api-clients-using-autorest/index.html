<!DOCTYPE html>
<!--
    Phantom by HTML5 UP
    html5up.net | @ajlkn
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en">

<head>

    <title>Patrik Svensson - Generating API clients using AutoRest</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/default.min.css">
    <!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/assets/css/main.css" />
    <!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
    <!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
    <link href="/assets/css/override.css" rel="stylesheet" />

    <meta name="description" content="This is my blog, where I write about stuff that interests me such as .NET, Rust, CI/CD and technology in general. I am a husband and a father, and I enjoy contributing to Open Source projects." />
    <link type="application/rss+xml" rel="alternate" title="Patrik Svensson" href="/feed.rss" />
    <link type="application/atom+xml" rel="alternate" title="Patrik Svensson" href="/feed.atom" />
    <!--<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">-->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/favicon/site.webmanifest">

    <meta name="application-name" content="Patrik Svensson" />
    <meta name="msapplication-tooltip" content="Patrik Svensson" />
    <meta name="msapplication-starturl" content="/" />

    <meta property="og:title" content="Patrik Svensson - Generating API clients using AutoRest" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://patriksvensson.se/2018/10/generating-api-clients-using-autorest" />
    <!-- TODO: More social graph meta tags -->

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>
</head>

<body>
    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Header -->
        <header id="header">
            <div class="inner">

                <!-- Logo -->
                <a href="/" class="logo">
                    <span class="title">Patrik Svensson</span>
                </a>

            </div>
        </header>

        <!-- Menu -->
        <nav id="menu">
            <h2>Menu</h2>
            <ul>
                <li><a href="/posts">Archive</a></li>
                <li><a href="/tags">Tags</a></li>
            </ul>
        </nav>

        <!-- Main -->
        <div id="main">
            <div class="inner">

                <header>
    <h1>Generating API clients using AutoRest</h1>
    <p><em>Published on Tuesday, October 2, 2018</em>
    </p>

    <ul class="actions small">
        <li><a role="button" href="/tags/autorest" class="button small ">AutoRest</a></li>
        <li><a role="button" href="/tags/csharp" class="button small ">C#</a></li>
        <li><a role="button" href="/tags/openapi" class="button small ">OpenAPI</a></li>
        <li><a role="button" href="/tags/swagger" class="button small ">Swagger</a></li>
    </ul>
</header>

<div id="content">
    <p>This blog post looks at automatically generating an HTTP API client
from a <a href="https://swagger.io/specification/">OpenAPI specification</a>
(formerly swagger) using <a href="http://azure.github.io/autorest/">AutoRest</a>.</p>
<p>We will also use another tool called <a href="https://github.com/domaindrivendev/Swashbuckle.AspNetCore">Swashbuckle</a>
which is an ASP.NET Core library that allows us to annotate our
controllers with metadata that is used to generate OpenAPI specifications.</p>
<!--excerpt-->
<h2 id="installing-autorest">Installing AutoRest</h2>
<p>The first thing we need to do is to install <code>AutoRest</code> globally on
our machine. If you have NPM installed on your computer, then this
can  be done by running the following command:</p>
<pre><code>&gt; npm install -g autorest
</code></pre>
<h2 id="setting-up-the-code-base">Setting up the code base</h2>
<p>For this project we're going to create a standard ASP.NET Core
web project, a class library that will hold our API client and
a PowerShell script to generate the client for us.</p>
<p>Why PowerShell and not Cake you might wonder if you know about
my involvement in the Cake project, and the reason is simple;
I want this guide to be as build agnostic as it can be, but
don't worry, I will follow up with a detailed guide of how to
convert the PowerShell script to a fully fledged Cake build script.</p>
<p>Start with creating the project.</p>
<pre><code>&gt; mkdir autorest-example
&gt; cd autorest-example
</code></pre>
<p>Now we want to create a source directory where the source code
for our API project will live.</p>
<pre><code>&gt; mkdir src
&gt; cd src
</code></pre>
<p>We continue by creating a solution file, and the two projects I
mention above using the dotnet CLI.</p>
<pre><code>&gt; dotnet new sln --name AutoRestExample
&gt; dotnet new webapi --name Sample.Api
&gt; dotnet new classlib --name Sample.Client
&gt; dotnet sln AutoRestExample.sln add ./Sample.Api/Sample.Api.csproj
&gt; dotnet sln AutoRestExample.sln add ./Sample.Client/Sample.Client.csproj
</code></pre>
<p>After this is done you can open the solution file in your editor of choice.
For this tutorial/guide I will be using Visual Studio, but nothing
stops you from using Visual Studio Code, Rider or a similar IDE/editor.</p>
<h2 id="modifying-the-api-project">Modifying the API project</h2>
<p>We're going to use a library called <code>Swashbuckle</code> to generate the OpenAPI
specification directly from our ASP.NET Core controllers, so we will need to
install the necessary NuGet packages.</p>
<ul>
<li><a href="http://nuget.org/packages/Swashbuckle.AspNetCore">Swashbuckle.AspNetCore</a></li>
<li><a href="https://www.nuget.org/packages/Swashbuckle.AspNetCore.Annotations">Swashbuckle.AspNetCore.Annotations</a></li>
</ul>
<p>We will also need the <code>Swashbuckle.AspNetCore.Cli</code> tool installed as part of
our project. This is not a package reference but a <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/extensibility#per-project-based-extensibility">project tool</a>, so we will need
to add the tool to our csproj manually. Right click on the <code>Sample.Api</code> project
in the solution explorer and paste the following snippet somewhere under the
<code>&lt;Project&gt;</code> node.</p>
<pre><code class="language-xml">&lt;ItemGroup&gt;
  &lt;DotNetCliToolReference Include=&quot;Swashbuckle.AspNetCore.Cli&quot; Version=&quot;3.0.0-beta1&quot; /&gt;
&lt;/ItemGroup&gt;
</code></pre>
<h3 id="the-controller">The controller</h3>
<p>Open up <code>Controllers/ValuesController.cs</code> and replace the content with the following
code:</p>
<pre><code class="language-csharp">using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using Swashbuckle.AspNetCore.Annotations;

namespace Sample.Api.Controllers
{
    [ApiController]
    [Route(&quot;api/[controller]&quot;)]
    public class ValuesController : ControllerBase
    {
        [HttpGet]
        [ProducesResponseType(typeof(ICollection&lt;string&gt;), 200)]
        [SwaggerOperation(OperationId = &quot;Values_GetAll&quot;)]
        public ActionResult&lt;ICollection&lt;string&gt;&gt; Get()
        {
            return new string[] { &quot;foo&quot;, &quot;bar&quot; };
        }
    }
}
</code></pre>
<p>As you can see we have a method that returns a collection of string. We've decorated
the method with two additional attributes that tells <code>Swashbuckle</code> that this method
will return a collection of strings if the HTTP response code is <code>200</code>. We're also
setting an <a href="">Swagger operation ID</a> for the method that will be used when we generate
our client.</p>
<h3 id="wiring-up-the-api">Wiring up the API</h3>
<p>We now have a controller that's decorated with the necessary attributes for <code>Swashbuckle</code>
to generate a Swagger specification from it. We now have to wire everything up in the
<code>Startup.cs</code> file.</p>
<p>In the <code>ConfigureServices</code> method, add the following code that will tell <code>Swashbuckle</code> that
we've annotated our controllers with annotations, and provide some metadata for the API.</p>
<pre><code class="language-csharp">services.AddSwaggerGen(c =&gt;
{
    c.EnableAnnotations();
    c.SwaggerDoc(&quot;v1&quot;, new Info
    {
        Title = &quot;Sample API&quot;,
        Version = &quot;v1&quot;
    });
});
</code></pre>
<p>We now have to add the <code>Swashbuckle</code> middleware to our application pipeline which we do by
adding the following code last in the <code>Configure</code> method. You can also (optionally) add
the UI, but this is not required for what we're trying to achieve.</p>
<pre><code class="language-csharp">app.UseSwagger();

// Optional
app.UseSwaggerUI(c =&gt;
{
    c.SwaggerEndpoint(&quot;/swagger/v1/swagger.json&quot;, &quot;Sample API&quot;);
});
</code></pre>
<p>If you run the project and navigate to <code>/swagger/v1/swagger.json</code>, you will see
the generated Swagger specification that represents our API.</p>
<h3 id="modifying-the-client-project">Modifying the client project</h3>
<p>The last thing we need to do before actually generating a client is to add a
reference to the <code>Microsoft.Rest.ClientRuntime</code> NuGet package in the <code>Sample.Client</code> project.
This package contains everything that a generated <code>AutoRest</code> client requires to work.</p>
<h2 id="generating-the-client-code">Generating the client code</h2>
<p>Now we want to start generating the client code, but we don't want to get the Swagger
document by starting the API and retrieving it. It's absolutely possible but will be hard
to automate.</p>
<p>It's here the <code>Swashbuckle.AspNetCore.Cli</code> package comes into play.<br />
What this package does is to allow to generate the Swagger document from a built assembly
instead of invoking the Swagger endpoint of our API project.</p>
<p>What we need to do now is:</p>
<ol>
<li>Build the Sample.API project.</li>
<li>Generate the Swagger definition from the built assembly.</li>
<li>Generate the client from the Swagger definition using <code>AutoRest</code>.</li>
</ol>
<p>Like I mentioned before, we're going to use PowerShell to do this, so go ahead and create
a <code>Generate.ps1</code> file in the root of our project structure. The file should look like following:</p>
<pre><code class="language-powershell">Set-Location src

# Build project.
dotnet build

# Create the Swagger file from the API assembly.
Set-Location Sample.Api
dotnet swagger &quot;tofile&quot; --output &quot;../../res/swagger.json&quot; &quot;../Sample.Api/bin/Debug/netcoreapp2.1/Sample.Api.dll&quot; v1
Set-Location ..

# Clear the previously generated code.
Remove-Item &quot;Sample.Client/Generated&quot; -Force -Recurse

# Generate a C# client from the Swagger definition and
# override the namespace and the client name.
autorest --input-file=&quot;../res/swagger.json&quot; `
         --output-folder=&quot;Sample.Client/Generated&quot; `
         --namespace=&quot;Sample.Client&quot; `
         --override-client-name=&quot;SampleClient&quot; `
         --csharp

# Reset the location.
Set-Location ..
</code></pre>
<p>By running this script you should find a folder called <code>Generated</code> in the Client project
containing the API client.</p>
<p>All classes are partial (as well as some methods) so if you need to inject your own logic
or change some behavior (such as authentication), you have the possibility to do so.</p>
<h2 id="closing-up">Closing up</h2>
<p>This tutorial just goes through the basics of how to generate an API client, but there is
a myriad of other options that you can use to customize the generated client to your
exact needs. I've personally haven't encountered a single scenario that couldn't be solved
by one of the extensibility points in the generated code.</p>
<p>I also recommend you to always commit the generated Swagger file as part of your repository.
That way you always have a way to quickly regenerate the client if you manage to break something.</p>
<p>You can find the source code to this blog post at
<a href="https://github.com/patriksvensson/autorest-example">https://github.com/patriksvensson/autorest-example</a></p>

</div>

            </div>
        </div>

        <!-- Footer -->
        <footer id="footer">
            <div class="inner">
                <ul class="copyright">
                    <li>Copyright © 2020 Patrik Svensson</li>
                    <li>Blog forked from <a href="https://github.com/mholo65/mholo65">Martin Björkström</a></li>
                    <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                    <li><a href="https://statiq.dev/">Generated by Statiq</a></li>
                </ul>
            </div>

        </footer>

    </div>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53005417-1', 'auto');
    ga('send', 'pageview');
</script>
    <!-- Scripts -->
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/skel.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
    <script src="/assets/js/main.js"></script>

</body>

</html>