<!DOCTYPE html><html lang="en"><head>

    <title>Patrik Svensson - How to write a stateful Roslyn analyzer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link type="application/rss+xml" rel="alternate" title="Patrik Svensson" href="/feed.rss">
    <link type="application/atom+xml" rel="alternate" title="Patrik Svensson" href="/feed.atom">

    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">

    <link href="/assets/styles.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">

    <meta name="description" content="This is my blog, where I write about stuff that interests me such as .NET, Rust, DevOps and technology in general. I am a husband and a father, and I enjoy contributing to Open Source projects.">

        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="Patrik Svensson">
        <meta name="twitter:title" content="How to write a stateful Roslyn analyzer">
        <meta name="twitter:creator" content="This is my blog, where I write about stuff that interests me such as .NET, Rust, DevOps and technology in general. I am a husband and a father, and I enjoy contributing to Open Source projects.">
        <meta name="twitter:description" content="This is my blog, where I write about stuff that interests me such as .NET, Rust, DevOps and technology in general. I am a husband and a father, and I enjoy contributing to Open Source projects.">
        <meta name="twitter:image" content="https://patriksvensson.se/posts/2020/03/how-to-write-a-stateful-roslyn-analyzer-social.png">
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    
</head>
<body class="antialiased text-base-800 bg-base-800/10 dark:bg-base-800 transition-colors">
<header class="sticky top-0 left-2 w-full backdrop-blur bg-base-100/80 dark:bg-base-800/80 border-b border-base-900/20 dark:border-base-50/10 shadow-md dark:shadow-lg py-2 md:py-4 z-50">
    <nav class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 flex  items-center">
        <h1>
            <a class="font-extrabold text-2xl sm:text-3xl md:text-3xl base:text-3xl lg:text-4xl xl:text-4xl text-base-700 dark:text-base-300" href="/">
                Patrik Svensson
            </a>
        </h1>

        <div class="ml-auto flex items-center">
            <a class="ml-2 mr-4 text-base-400 hover:text-blue-400 transition-all hover:scale-105" title="Twitter" href="https://twitter.com/firstdrafthell">
                <svg width="1.7rem" height="1.7rem" class="fill-current" viewBox="328 355 335 276" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M 630, 425 A 195, 195 0 0 1 331, 600 A 142, 142 0 0 0 428, 570 A  70,  70 0 0 1 370, 523 A  70,  70 0 0 0 401, 521 A  70,  70 0 0 1 344, 455 A  70,  70 0 0 0 372, 460 A  70,  70 0 0 1 354, 370 A 195, 195 0 0 0 495, 442 A  67,  67 0 0 1 611, 380 A 117, 117 0 0 0 654, 363 A  65,  65 0 0 1 623, 401 A 117, 117 0 0 0 662, 390 A  65,  65 0 0 1 630, 425 Z"></path>
                </svg>
            </a>

            <a class="mr-4 text-base-400 hover:text-blue-400 transition-all hover:scale-105" title="LinkedIn" href="https://www.linkedin.com/in/psvensson82/">
                <svg width="1.7rem" height="1.7rem" class="fill-current" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M150.65,100.682c0,27.992-22.508,50.683-50.273,50.683c-27.765,0-50.273-22.691-50.273-50.683
                    C50.104,72.691,72.612,50,100.377,50C128.143,50,150.65,72.691,150.65,100.682z M143.294,187.333H58.277V462h85.017V187.333z
                    M279.195,187.333h-81.541V462h81.541c0,0,0-101.877,0-144.181c0-38.624,17.779-61.615,51.807-61.615
                    c31.268,0,46.289,22.071,46.289,61.615c0,39.545,0,144.181,0,144.181h84.605c0,0,0-100.344,0-173.915
                    s-41.689-109.131-99.934-109.131s-82.768,45.369-82.768,45.369V187.333z"></path>
                </svg>
            </a>

            <a class="text-base-400 hover:text-blue-400 transition-all hover:scale-105" title="GitHub" href="https://github.com/patriksvensson">
                <svg width="1.7rem" height="1.7rem" class="fill-current" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)"></path>
                </svg>
            </a>
        </div>
    </nav>

    <nav class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 py-1 flex items-center">
        <a class="text-base-500 hover:text-blue-400 transition-all mr-4" href="/about">About</a>
        <a class="text-base-500 hover:text-blue-400 transition-all" href="https://github.com/sponsors/patriksvensson">Sponsor me</a>

        <div class="ml-auto flex items-center">
        <button aria-label="Toggle Dark Mode" class="ml-2 text-yellow-600 dark:text-base-500 stroke-1 opacity-80" style="padding-right: 2px;" onclick="swapTheme()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
        </button>
        </div>
    </nav>
</header>

<main class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 mt-4 mb-4 md:mb-16 font-light">
    <header class="mt-6 mb-4 lg:mb-8">
            <h2 class="font-bold text-primary-700/90 dark:text-primary-500/90 text-3xl lg:font-extrabold lg:text-4xl ">How to write a stateful Roslyn analyzer</h2>

    <div class="mt-4">
        <p class="mb-1 lg:my-b text-sm dark:text-gray-200">Posted <time>Saturday, March 7, 2020</time></p>
        
<ul class="flex space-x-1 md:space-x-2 mb-4 overflow-hidden">
<li class="text-xs md:text-sm py-1 px-2 md:py-2 md:px-4 text-primary-100 bg-primary-700/80 border border-primary-600/80 dark:text-base-100 dark:bg-primary-900/75 dark:hover:bg-base-900 dark:border-base-800 rounded md:rounded-md">
            <a href="/tags/csharp"> C#</a>
        </li>
<li class="text-xs md:text-sm py-1 px-2 md:py-2 md:px-4 text-primary-100 bg-primary-700/80 border border-primary-600/80 dark:text-base-100 dark:bg-primary-900/75 dark:hover:bg-base-900 dark:border-base-800 rounded md:rounded-md">
            <a href="/tags/roslyn"> Roslyn</a>
        </li>
<li class="text-xs md:text-sm py-1 px-2 md:py-2 md:px-4 text-primary-100 bg-primary-700/80 border border-primary-600/80 dark:text-base-100 dark:bg-primary-900/75 dark:hover:bg-base-900 dark:border-base-800 rounded md:rounded-md">
            <a href="/tags/net"> .NET</a>
        </li>
</ul>
    
    </div>
    </header>
    
    


<article class="prose dark:prose-invert mt-8 lg:prose-lg max-w-full font-light lg:leading-loose">
    <p>I wrote a stateful Roslyn analyzer a couple of days ago to analyze the codebase
at work for irregularities, and I thought I would share my findings on how I did
it.</p>
<h2 id="the-goal">The goal</h2>
<p>Our goal for this blog post is to write an analyzer that finds all non-abstract
classes that implement <code>IRequest&lt;TResult&gt;</code>, and check whether or not they have
an associated request handler <code>RequestHandler&lt;TRequest, TResult&gt;</code>.</p>
<p>The algorithm for our analyzer is kind of straight forward.</p>
<ol>
<li>Find all non-abstract classes that implement <code>IRequest&lt;TResult&gt;</code></li>
<li>Find all non-abstract classes that inherit from <code>RequestHandler&lt;TRequest, TResult&gt;</code></li>
<li>Once the compilation finished, find all requests that don't have a handler
and report a diagnostic for each of them.</li>
</ol>
<p>We won't cover the actual setup of the analyzer project, but head over to
<a href="https://devblogs.microsoft.com/dotnet/how-to-write-a-roslyn-analyzer">https://devblogs.microsoft.com/dotnet/how-to-write-a-roslyn-analyzer</a> and follow
Mika's excellent tutorial on this and comes back after that. I'll wait.</p>
<h2 id="setting-everything-up">Setting everything up</h2>
<p>Ok, now, when you've got a project set up, let's create the boilerplate for the
request analyzer. Start by removing any existing analyzers and code fixes from the
project and create a new analyzer.</p>
<pre><code class=""><span class="token keyword roslyn-keyword">using</span> <span class="token symbol roslyn-identifier">System</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">Collections</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">Immutable</span><span class="token punctuation roslyn-punctuation">;</span>
<span class="token keyword roslyn-keyword">using</span> <span class="token symbol roslyn-identifier">Microsoft</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">CodeAnalysis</span><span class="token punctuation roslyn-punctuation">;</span>
<span class="token keyword roslyn-keyword">using</span> <span class="token symbol roslyn-identifier">Microsoft</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">CodeAnalysis</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">Diagnostics</span><span class="token punctuation roslyn-punctuation">;</span>

<span class="token keyword roslyn-keyword">namespace</span> <span class="token namespace-name roslyn-namespace-name">RequestAnalyzer</span>
<span class="token punctuation roslyn-punctuation">{</span>
    <span class="token punctuation roslyn-punctuation">[</span><span class="token symbol roslyn-identifier">DiagnosticAnalyzer</span><span class="token punctuation roslyn-punctuation">(</span><span class="token symbol roslyn-identifier">LanguageNames</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">CSharp</span><span class="token punctuation roslyn-punctuation">)</span><span class="token punctuation roslyn-punctuation">]</span>
    <span class="token keyword roslyn-keyword">public</span> <span class="token keyword roslyn-keyword">class</span> <span class="token title.class roslyn-class-name">RequestAnalyzer</span> <span class="token punctuation roslyn-punctuation">:</span> <span class="token symbol roslyn-identifier">DiagnosticAnalyzer</span>
    <span class="token punctuation roslyn-punctuation">{</span>
        <span class="token keyword roslyn-keyword">public</span> <span class="token keyword roslyn-keyword">const</span> <span class="token keyword roslyn-keyword">string</span> <span class="token constant-name roslyn-constant-name">DiagnosticId</span> <span class="token operator roslyn-operator">=</span> <span class="token string roslyn-string">"RequestAnalyzer"</span><span class="token punctuation roslyn-punctuation">;</span>
        <span class="token keyword roslyn-keyword">private</span> <span class="token keyword roslyn-keyword">static</span> <span class="token symbol roslyn-identifier">DiagnosticDescriptor</span> Rule <span class="token operator roslyn-operator">=</span> <span class="token keyword roslyn-keyword">new</span> <span class="token symbol roslyn-identifier">DiagnosticDescriptor</span><span class="token punctuation roslyn-punctuation">(</span>
            DiagnosticId<span class="token punctuation roslyn-punctuation">,</span> <span class="token string roslyn-string">"Request does not have an associated handler"</span><span class="token punctuation roslyn-punctuation">,</span>
            <span class="token string roslyn-string">"The request '{0}' does not have an associated handler."</span><span class="token punctuation roslyn-punctuation">,</span> <span class="token string roslyn-string">"Maintenance"</span><span class="token punctuation roslyn-punctuation">,</span>
            <span class="token symbol roslyn-identifier">DiagnosticSeverity</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">Warning</span><span class="token punctuation roslyn-punctuation">,</span> <span class="token symbol roslyn-identifier">isEnabledByDefault</span><span class="token punctuation roslyn-punctuation">:</span> <span class="token keyword roslyn-keyword">true</span><span class="token punctuation roslyn-punctuation">,</span>
            <span class="token symbol roslyn-identifier">description</span><span class="token punctuation roslyn-punctuation">:</span> <span class="token string roslyn-string">"Requests should have an associated handler"</span><span class="token punctuation roslyn-punctuation">)</span><span class="token punctuation roslyn-punctuation">;</span>

        <span class="token keyword roslyn-keyword">public</span> <span class="token keyword roslyn-keyword">override</span> <span class="token symbol roslyn-identifier">ImmutableArray</span><span class="token punctuation roslyn-punctuation"><</span><span class="token symbol roslyn-identifier">DiagnosticDescriptor</span><span class="token punctuation roslyn-punctuation">></span> <span class="token property roslyn-property-name">SupportedDiagnostics</span>
        <span class="token punctuation roslyn-punctuation">{</span>
            <span class="token keyword roslyn-keyword">get</span> <span class="token punctuation roslyn-punctuation">{</span> <span class="token keyword roslyn-keyword---control">return</span> <span class="token symbol roslyn-identifier">ImmutableArray</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">Create</span><span class="token punctuation roslyn-punctuation">(</span>Rule<span class="token punctuation roslyn-punctuation">)</span><span class="token punctuation roslyn-punctuation">;</span> <span class="token punctuation roslyn-punctuation">}</span>
        <span class="token punctuation roslyn-punctuation">}</span>

        <span class="token keyword roslyn-keyword">public</span> <span class="token keyword roslyn-keyword">override</span> <span class="token keyword roslyn-keyword">void</span> <span class="token title.function roslyn-method-name">Initialize</span><span class="token punctuation roslyn-punctuation">(</span><span class="token symbol roslyn-identifier">AnalysisContext</span> <span class="token property roslyn-parameter-name">analysisContext</span><span class="token punctuation roslyn-punctuation">)</span>
        <span class="token punctuation roslyn-punctuation">{</span>
            <span class="token property roslyn-parameter-name">analysisContext</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">ConfigureGeneratedCodeAnalysis</span><span class="token punctuation roslyn-punctuation">(</span><span class="token symbol roslyn-identifier">GeneratedCodeAnalysisFlags</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">Analyze</span><span class="token punctuation roslyn-punctuation">)</span><span class="token punctuation roslyn-punctuation">;</span>
            <span class="token property roslyn-parameter-name">analysisContext</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">EnableConcurrentExecution</span><span class="token punctuation roslyn-punctuation">(</span><span class="token punctuation roslyn-punctuation">)</span><span class="token punctuation roslyn-punctuation">;</span>
            <span class="token property roslyn-parameter-name">analysisContext</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">RegisterCompilationStartAction</span><span class="token punctuation roslyn-punctuation">(</span><span class="token symbol roslyn-identifier">Analyze</span><span class="token punctuation roslyn-punctuation">)</span><span class="token punctuation roslyn-punctuation">;</span>
        <span class="token punctuation roslyn-punctuation">}</span>

        <span class="token keyword roslyn-keyword">private</span> <span class="token keyword roslyn-keyword">void</span> <span class="token title.function roslyn-method-name">Analyze</span><span class="token punctuation roslyn-punctuation">(</span><span class="token symbol roslyn-identifier">CompilationStartAnalysisContext</span> <span class="token property roslyn-parameter-name">startContext</span><span class="token punctuation roslyn-punctuation">)</span>
        <span class="token punctuation roslyn-punctuation">{</span>
        <span class="token punctuation roslyn-punctuation">}</span>
    <span class="token punctuation roslyn-punctuation">}</span>
<span class="token punctuation roslyn-punctuation">}</span>
</code></pre>
<p>Once we have all the boilerplate in place, we'll create a test that will verify that
our analyzer works as expected.</p>
<pre><code class=""><span class="token punctuation roslyn-punctuation">[</span><span class="token symbol roslyn-identifier">TestClass</span><span class="token punctuation roslyn-punctuation">]</span>
<span class="token keyword roslyn-keyword">public</span> <span class="token keyword roslyn-keyword">class</span> <span class="token title.class roslyn-class-name">UnitTest</span> <span class="token punctuation roslyn-punctuation">:</span> <span class="token symbol roslyn-identifier">CodeFixVerifier</span>
<span class="token punctuation roslyn-punctuation">{</span>
    <span class="token keyword roslyn-keyword">protected</span> <span class="token keyword roslyn-keyword">override</span> <span class="token symbol roslyn-identifier">DiagnosticAnalyzer</span> <span class="token title.function roslyn-method-name">GetCSharpDiagnosticAnalyzer</span><span class="token punctuation roslyn-punctuation">(</span><span class="token punctuation roslyn-punctuation">)</span>
    <span class="token punctuation roslyn-punctuation">{</span>
        <span class="token keyword roslyn-keyword---control">return</span> <span class="token keyword roslyn-keyword">new</span> <span class="token symbol roslyn-identifier">RequestAnalyzer</span><span class="token punctuation roslyn-punctuation">(</span><span class="token punctuation roslyn-punctuation">)</span><span class="token punctuation roslyn-punctuation">;</span>
    <span class="token punctuation roslyn-punctuation">}</span>

    <span class="token punctuation roslyn-punctuation">[</span><span class="token symbol roslyn-identifier">TestMethod</span><span class="token punctuation roslyn-punctuation">]</span>
    <span class="token keyword roslyn-keyword">public</span> <span class="token keyword roslyn-keyword">void</span> <span class="token title.function roslyn-method-name">Should_Return_Diagnostic_For_Missing_Command_Handler</span><span class="token punctuation roslyn-punctuation">(</span><span class="token punctuation roslyn-punctuation">)</span>
    <span class="token punctuation roslyn-punctuation">{</span>
        <span class="token keyword roslyn-keyword">var</span> <span class="token variable roslyn-local-name">test</span> <span class="token operator roslyn-operator">=</span> <span class="token string roslyn-string---verbatim">@"
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Diagnostics;

namespace Foo
{
    public interface IRequest<tresult>
    {
    }

    public sealed class MyRequest : IRequest<int>
    {
    }

    public abstract class AbstractRequest : IRequest<int>
    {
    }

    public sealed class MyOtherRequest : IRequest<int>
    {
    }

    public sealed class MyRequestHandler : RequestHandler<myrequest, int="">
    {
    }
}"</myrequest,></int></int></int></tresult></span><span class="token punctuation roslyn-punctuation">;</span>
        <span class="token keyword roslyn-keyword">var</span> <span class="token variable roslyn-local-name">expected</span> <span class="token operator roslyn-operator">=</span> <span class="token keyword roslyn-keyword">new</span> <span class="token symbol roslyn-identifier">DiagnosticResult</span>
        <span class="token punctuation roslyn-punctuation">{</span>
            <span class="token symbol roslyn-identifier">Id</span> <span class="token operator roslyn-operator">=</span> <span class="token string roslyn-string">"RequestAnalyzer"</span><span class="token punctuation roslyn-punctuation">,</span>
            <span class="token symbol roslyn-identifier">Message</span> <span class="token operator roslyn-operator">=</span> <span class="token string roslyn-string">"The request 'MyOtherRequest' does not have an associated handler."</span><span class="token punctuation roslyn-punctuation">,</span>
            <span class="token symbol roslyn-identifier">Severity</span> <span class="token operator roslyn-operator">=</span> <span class="token symbol roslyn-identifier">DiagnosticSeverity</span><span class="token operator roslyn-operator">.</span><span class="token symbol roslyn-identifier">Warning</span><span class="token punctuation roslyn-punctuation">,</span>
            <span class="token symbol roslyn-identifier">Locations</span> <span class="token operator roslyn-operator">=</span>
                <span class="token keyword roslyn-keyword">new</span><span class="token punctuation roslyn-punctuation">[</span><span class="token punctuation roslyn-punctuation">]</span> <span class="token punctuation roslyn-punctuation">{</span>
                        <span class="token keyword roslyn-keyword">new</span> <span class="token symbol roslyn-identifier">DiagnosticResultLocation</span><span class="token punctuation roslyn-punctuation">(</span><span class="token string roslyn-string">"Test0.cs"</span><span class="token punctuation roslyn-punctuation">,</span> <span class="token number roslyn-number">23</span><span class="token punctuation roslyn-punctuation">,</span> <span class="token number roslyn-number">29</span><span class="token punctuation roslyn-punctuation">)</span>
                    <span class="token punctuation roslyn-punctuation">}</span>
        <span class="token punctuation roslyn-punctuation">}</span><span class="token punctuation roslyn-punctuation">;</span>

        <span class="token symbol roslyn-identifier">VerifyCSharpDiagnostic</span><span class="token punctuation roslyn-punctuation">(</span><span class="token variable roslyn-local-name">test</span><span class="token punctuation roslyn-punctuation">,</span> <span class="token variable roslyn-local-name">expected</span><span class="token punctuation roslyn-punctuation">)</span><span class="token punctuation roslyn-punctuation">;</span>
    <span class="token punctuation roslyn-punctuation">}</span>
<span class="token punctuation roslyn-punctuation">}</span>
</code></pre>
<p>The test will set up the source code that will be analyzed and some expectations.
Notice that we need to specify the <code>IRequest&lt;TResult&gt;</code> definition in our code.
When Roslyn encounters an unknown type during a diagnostic run, it will assume
it's a type, so by specifying this, Roslyn will know that it's an interface.</p>
<h2 id="writing-the-actual-analyzer">Writing the actual analyzer</h2>
<p>So, the first step is finding the requests and the request handlers and store
them somewhere. For this, we'll register a callback that will be called every
time the semantic analysis of a class, enum, or interface has been completed. In
the callback, we will check if the type fits the criteria and store it in a
<code>ConcurrentBag</code>.</p>
<pre><code>private void Analyze(CompilationStartAnalysisContext startContext)
{
    var handlers = new ConcurrentBag&lt;INamedTypeSymbol&gt;();
    var requests = new ConcurrentBag&lt;INamedTypeSymbol&gt;();

    startContext.RegisterSymbolAction(context =&gt;
    {
        var type = (INamedTypeSymbol)context.Symbol;
        if (type.TypeKind == TypeKind.Class)
        {
            if (type.IsAbstract || type.IsStatic)
            {
                return;
            }

            // Is this a request handler?
            if (type.BaseType != null &amp;&amp; type.BaseType.Name == &quot;RequestHandler&quot; &amp;&amp;
                type.BaseType.TypeArguments.Length == 2)
            {
                handlers.Add(type);
            }
            // Is this a request?
            else if (type.Interfaces.Any(x =&gt; x.Name == &quot;IRequest&quot; &amp;&amp; x.TypeArguments.Length == 1))
            {
                requests.Add(type);
            }
        }
    }, SymbolKind.NamedType);
}
</code></pre>
<p>Now when we have all the information we need, we need to perform our actual
analysis of the data we've collected. For this, we register another callback
that will be invoked once the compilation is done using
<code>RegisterCompilationEndAction</code>.</p>
<p>One problem with using
<code>RegisterCompilationEndAction</code> is that it won't be fired unless full solution
analysis is enabled. So unless you only care about feedback when building
outside of Visual Studio, you will have to
<a href="https://docs.microsoft.com/en-us/visualstudio/code-quality/how-to-enable-and-disable-full-solution-analysis-for-managed-code?view=vs-2019">turn that on</a>.</p>
<pre><code>private void Analyze(CompilationStartAnalysisContext startContext)
{
    var handlers = new ConcurrentBag&lt;INamedTypeSymbol&gt;();
    var requests = new ConcurrentBag&lt;INamedTypeSymbol&gt;();

    // [Omitted]

    startContext.RegisterCompilationEndAction(context =&gt;
    {
        // Check all requests.
        foreach (var request in requests)
        {
            var found = false;

            // Now check all handlers.
            foreach (var handler in handlers)
            {
                // Is this handler an implementation for our request?
                // I.e. RequestHandler&lt;Foo, int&gt; for Foo? Check this by comparing
                // the first type argument with the name of the request.
                if (handler.BaseType.TypeArguments[0].Name == request.Name)
                {
                    // Yes, we found it.
                    found = true;
                    break;
                }
            }

            if (!found)
            {
                // Report a diagnostic for the first occurance of the symbol.
                context.ReportDiagnostic(Diagnostic.Create(
                    MissingRequestHandler,
                    request.Locations.FirstOrDefault(),
                    request.Name));
            }
        }
    });
}
</code></pre>
<p>If we run our tests now, it will succeed!</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>Not as much code as you suspected, right? Of course, there are a gazillion
improvements that could be done to this analyzer (both when it comes to
performance and correctness), but I've tried to keep it as simple as possible
for this blog post. I'll leave any improvements as an exercise to the reader. ;)</p>

</article>

    <div class="flex mt-8 md:mt-12 mb-8 p-4 border border-primary-400/50  bg-primary-200/50 dark:border-primary-800 dark:bg-primary-700/50 shadow-md rounded-md items-center">
        <svg class="fill-current text-primary-900/75 dark:text-primary-300/75" width="2rem" height="2rem" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 1024 1024" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)"></path>
        </svg>
        <p class="ml-4 text-base-700 dark:text-primary-300 text-xs md:text-sm">View the supporting repository at <a class="font-normal break-all" href="https://github.com/patriksvensson/stateful-roslyn-analyzer">https://github.com/patriksvensson/stateful-roslyn-analyzer</a></p>
    </div>

</main>

<footer>
    <span class="mx-auto  text-base-800 dark:text-base-200 py-4 max-w-4xl block text-sm font-light text-center">
        &copy; Patrik Svensson<br>
        Blog design by <a class="text-blue-700 dark:text-blue-300" href="https://github.com/phil-scott-78/thirty25-statiq">Phil Scott</a> 
        | Built with <a class="text-blue-700 dark:text-blue-300" href="https://statiq.dev/">Statiq</a>
    </span>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/prism.min.js" integrity="sha512-pSVqGtpGygQlhN8ZTHXx1kqkjQr30eM+S6OoSzhHGTjh6DKdfy7WZlo1DNO9bhtM0Imf6xNLznZ7iVC2YUMwJQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-GP4x8UWxWyh4BMbyJGOGneiTbkrWEF5izsVJByzVLodP8CuJH/n936+yQDMJJrOPUHLgyPbLiGw2rXmdvGdXHA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
            function swapTheme(){
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }                
            }
        </script>

</body></html>