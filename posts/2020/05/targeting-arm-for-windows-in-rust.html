
<!DOCTYPE html>
<html lang="en">
<head>

    <title>Patrik Svensson - Targeting ARM64 for Windows in Rust</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <link type="application/rss+xml" rel="alternate" title="Patrik Svensson" href="/feed.rss" />
    <link type="application/atom+xml" rel="alternate" title="Patrik Svensson" href="/feed.atom" />

    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">

    <link href="/assets/styles.css" rel="stylesheet"/>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>

    <meta name="description" content="This is my blog, where I write about stuff that interests me such as .NET, Rust, DevOps and technology in general. I am a husband and a father, and I enjoy contributing to Open Source projects.">

        <meta name="twitter:card" content="summary_large_image"/>
        <meta name="twitter:site" content="Patrik Svensson"/>
        <meta name="twitter:title" content="Targeting ARM64 for Windows in Rust"/>
        <meta name="twitter:creator" content="This is my blog, where I write about stuff that interests me such as .NET, Rust, DevOps and technology in general. I am a husband and a father, and I enjoy contributing to Open Source projects.">
        <meta name="twitter:description" content="This is my blog, where I write about stuff that interests me such as .NET, Rust, DevOps and technology in general. I am a husband and a father, and I enjoy contributing to Open Source projects."/>
        <meta name="twitter:image" content="https://patriksvensson.se/posts/2020/05/targeting-arm-for-windows-in-rust-social.png"/>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    
</head>
<body class="antialiased text-base-800 bg-base-800/10 dark:bg-base-800 transition-colors">
<header class="sticky top-0 left-2 w-full backdrop-blur bg-base-100/80 dark:bg-base-800/80 border-b border-base-900/20 dark:border-base-50/10 shadow-md dark:shadow-lg py-2 md:py-4 z-50">
    <nav class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 flex  items-center">
        <h1>
            <a class="font-extrabold text-2xl sm:text-3xl md:text-3xl base:text-3xl lg:text-4xl xl:text-4xl text-base-700 dark:text-base-300" href="/">
                Patrik Svensson
            </a>
        </h1>

        <div class="ml-auto flex items-center">
            <a class="ml-2 mr-4 text-base-400 hover:text-blue-400 transition-all hover:scale-105" title="Twitter" href="https://twitter.com/firstdrafthell">
                <svg width="1.7rem" height="1.7rem" class="fill-current" viewBox="328 355 335 276" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path  d="M 630, 425 A 195, 195 0 0 1 331, 600 A 142, 142 0 0 0 428, 570 A  70,  70 0 0 1 370, 523 A  70,  70 0 0 0 401, 521 A  70,  70 0 0 1 344, 455 A  70,  70 0 0 0 372, 460 A  70,  70 0 0 1 354, 370 A 195, 195 0 0 0 495, 442 A  67,  67 0 0 1 611, 380 A 117, 117 0 0 0 654, 363 A  65,  65 0 0 1 623, 401 A 117, 117 0 0 0 662, 390 A  65,  65 0 0 1 630, 425 Z" />
                </svg>
            </a>

            <a class="mr-4 text-base-400 hover:text-blue-400 transition-all hover:scale-105" title="LinkedIn" href="https://www.linkedin.com/in/psvensson82/">
                <svg width="1.7rem" height="1.7rem" class="fill-current" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M150.65,100.682c0,27.992-22.508,50.683-50.273,50.683c-27.765,0-50.273-22.691-50.273-50.683
                    C50.104,72.691,72.612,50,100.377,50C128.143,50,150.65,72.691,150.65,100.682z M143.294,187.333H58.277V462h85.017V187.333z
                    M279.195,187.333h-81.541V462h81.541c0,0,0-101.877,0-144.181c0-38.624,17.779-61.615,51.807-61.615
                    c31.268,0,46.289,22.071,46.289,61.615c0,39.545,0,144.181,0,144.181h84.605c0,0,0-100.344,0-173.915
                    s-41.689-109.131-99.934-109.131s-82.768,45.369-82.768,45.369V187.333z"/>
                </svg>
            </a>

            <a class="text-base-400 hover:text-blue-400 transition-all hover:scale-105" title="GitHub" href="https://github.com/patriksvensson">
                <svg width="1.7rem" height="1.7rem" class="fill-current" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)"/>
                </svg>
            </a>
        </div>
    </nav>

    <nav class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 py-1 flex items-center">
        <a class="text-base-500 hover:text-blue-400 transition-all mr-4" href="/about">About</a>
        <a class="text-base-500 hover:text-blue-400 transition-all" href="https://github.com/sponsors/patriksvensson">Sponsor me</a>

        <div class="ml-auto flex items-center">
        <button aria-label="Toggle Dark Mode" class="ml-2 text-yellow-600 dark:text-base-500 stroke-1 opacity-80" style="padding-right: 2px;" onclick="swapTheme()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6"  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </button>
        </div>
    </nav>
</header>

<main class="mx-auto max-w-5xl px-4 md:px-8 xl:px-0 mt-4 mb-4 md:mb-16 font-light">
    <header class="mt-6 mb-4 lg:mb-8">
            <h2 class="font-bold text-primary-700/90 dark:text-primary-500/90 text-3xl lg:font-extrabold lg:text-4xl ">Targeting ARM64 for Windows in Rust</h2>

    <div class="mt-4">
        <p class="mb-1 lg:my-b text-sm dark:text-gray-200">Posted <time>Tuesday, May 26, 2020</time></p>
        
<ul class="flex space-x-1 md:space-x-2 mb-4 overflow-hidden">
<li class="text-xs md:text-sm py-1 px-2 md:py-2 md:px-4 text-primary-100 bg-primary-700/80 border border-primary-600/80 dark:text-base-100 dark:bg-primary-900/75 dark:hover:bg-base-900 dark:border-base-800 rounded md:rounded-md">
            <a href="/tags/rust"> Rust</a>
        </li>
<li class="text-xs md:text-sm py-1 px-2 md:py-2 md:px-4 text-primary-100 bg-primary-700/80 border border-primary-600/80 dark:text-base-100 dark:bg-primary-900/75 dark:hover:bg-base-900 dark:border-base-800 rounded md:rounded-md">
            <a href="/tags/arm64"> ARM64</a>
        </li>
<li class="text-xs md:text-sm py-1 px-2 md:py-2 md:px-4 text-primary-100 bg-primary-700/80 border border-primary-600/80 dark:text-base-100 dark:bg-primary-900/75 dark:hover:bg-base-900 dark:border-base-800 rounded md:rounded-md">
            <a href="/tags/windows"> Windows</a>
        </li>
</ul>
    
    </div>
    </header>
    
    


<article class="prose dark:prose-invert mt-8 lg:prose-lg max-w-full font-light lg:leading-loose">
    <p>I wanted to run a thing I'm building with Rust on my Surface Pro X which is an
ARM64 device the other day. My initial thought when I got the idea, was
&quot;I hope it's not complicated to do&quot;.</p>
<p>TLDR; it wasn't.</p>
<!--excerpt-->
<h2 id="toolchain-targets">Toolchain targets</h2>
<p>One thing to be aware of is that ARM64, or <code>aarch64-pc-windows-msvc</code> as the toolchain
target is known as, is that it belongs in <code>tier 2</code> of Rust's platform support.</p>
<p>While tier 1 is &quot;<em>Guaranteed to run</em>&quot;, tier 2 is only &quot;<em>Guaranteed to build</em>&quot;.</p>
<blockquote>
<p>Tier 2 platforms can be thought of as &quot;guaranteed to build&quot;. Automated tests
are not run, so it's not guaranteed to produce a working build, but platforms often work to quite a good degree [...]</p>
</blockquote>
<p>So what do the different parts in the toolchain target name mean?</p>
<table>
  <tbody>
  <tr>
    <td><code>aarch64</code></td>
    <td>This is the platform architecture we're targeting, in this case, ARM64.</td>
  </tr>
  <tr>
    <td><code>pc-windows</code></td>
    <td>This is the operating system we're targeting, in this case, Windows.</td>
  </tr>
  <tr>
    <td><code>msvc</code></td>
    <td>This is the compiler we want to use. MSVC is an abbreviation of "Microsoft Visual C++".</td>
  </tr>
  </tbody>
</table>
<p>If you're interested in reading more about the different supported platforms
in Rust, you can find the full list over at<br />
<a href="https://forge.rust-lang.org/release/platform-support.html">https://forge.rust-lang.org/release/platform-support.html</a>.</p>
<h2 id="installing-the-toolchain-target">Installing the toolchain target</h2>
<p>Rust supports cross-compilation, so there's no need to build our ARM64 app on an
ARM64 machine, and even if we wanted to, it would prove difficult since essential
tools like <a href="https://doc.rust-lang.org/cargo/">Cargo</a> isn't available for ARM64 on
Windows. The only prerequisite for cross-compiling is a compiler
that can target the desired platform and all the necessary dependencies
required to compile the code.</p>
<p>To compile our application for ARM64, we need to install the
<code>aarch64-pc-windows-msvc</code> target for our Rust compiler toolchain.</p>
<pre><code class="language-text">&gt; rustup target install aarch64-pc-windows-msvc
</code></pre>
<p>If you want to see what toolchain targets are available or installed, you can
use the <code>rustup target list</code> command.</p>
<pre><code>&gt; rustup target list
aarch64-apple-ios
aarch64-fuchsia
aarch64-linux-android
aarch64-pc-windows-msvc (installed)
aarch64-unknown-linux-gnu
</code></pre>
<h2 id="building-for-arm64">Building for ARM64</h2>
<p>Now when the correct toolchain target has been installed, let's go ahead and
create a new binary and build it with our newly installed target.</p>
<pre><code class="language-text">&gt; cargo build --target=aarch64-pc-windows-msvc
   Compiling helloworld v0.1.0 (D:\Source\local\helloworld)
    Finished dev [unoptimized + debuginfo] target(s) in 0.36s
</code></pre>
<h3 id="automatically-build-with-a-specific-target">Automatically build with a specific target</h3>
<p>If you always want to build for this target, you can create<code>.cargo/config</code>
in your repository root and add the following contents to it:</p>
<pre><code class="language-toml">[build]
target = &quot;aarch64-pc-windows-msvc&quot;
</code></pre>
<h2 id="running-on-an-arm64-machine">Running on an ARM64 machine</h2>
<p>Everything compiled! Not a big surprise, it's &quot;Guaranteed to build&quot; after all,
but it felt good anyway. Time to test it out on an actual ARM64 machine.</p>
<pre><code class="language-text">&gt; ./helloworld.exe
-1073741515
</code></pre>
<h3 id="oh-noes">Oh noes</h3>
<p>The application exited with the error code <code>-1073741515</code>,
more famously known as <code>0xC0000135</code>, which is Windows' way of telling us that
an essential component is missing. It turns out that we need to install the
<a href="https://aka.ms/vs/16/release/VC_redist.arm64.exe"><em>Microsoft Visual C++ Redistributable for Visual Studio 2019</em></a>
for ARM64.</p>
<p>Installing the MSVC redistributable and rerunning our app
now produces the expected output.</p>
<pre><code class="language-text">&gt; ./helloworld.exe
Hello World
</code></pre>
<h2 id="wrapping-up">Wrapping up</h2>
<p>Not super complicated stuff, but hopefully this post has been useful for you if you
wanted to learn more about Rust's different platform tiers, toolchain targets, and cross-compilation.</p>

</article>


</main>

<footer>
    <span class="mx-auto  text-base-800 dark:text-base-200 py-4 max-w-4xl block text-sm font-light text-center">
        &copy; Patrik Svensson<br />
        Blog design by <a class="text-blue-700 dark:text-blue-300" href="https://github.com/phil-scott-78/thirty25-statiq">Phil Scott</a> 
        | Built with <a class="text-blue-700 dark:text-blue-300" href="https://statiq.dev/">Statiq</a>
    </span>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/prism.min.js" integrity="sha512-pSVqGtpGygQlhN8ZTHXx1kqkjQr30eM+S6OoSzhHGTjh6DKdfy7WZlo1DNO9bhtM0Imf6xNLznZ7iVC2YUMwJQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-GP4x8UWxWyh4BMbyJGOGneiTbkrWEF5izsVJByzVLodP8CuJH/n936+yQDMJJrOPUHLgyPbLiGw2rXmdvGdXHA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
            function swapTheme(){
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.theme = 'dark';
                }                
            }
        </script>
</body>
</html>